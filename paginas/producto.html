<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markline - Detalle de Producto</title>
    <link rel="stylesheet" href="main.css">
    <style>
        .producto-detalle {
            display: flex;
            flex-direction: column;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }

        .producto-header {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 30px;
        }

        .producto-imagenes {
            flex: 1;
            min-width: 300px;
        }

        .imagen-principal {
            width: 100%;
            height: 400px;
            object-fit: contain;
            border: 1px solid var(--letrados);
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .miniaturas-container {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 5px 0;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .miniaturas-container::-webkit-scrollbar {
            display: none;
        }

        .miniatura {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border: 2px solid transparent;
            border-radius: 5px;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.3s;
        }

        .miniatura:hover {
            border-color: var(--letrados);
        }

        .miniatura.seleccionada {
            border-color: var(--principal);
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }

        .miniatura-video {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f0f0f0;
        }

        .miniatura-video::before {
            content: "‚ñ∂";
            position: absolute;
            font-size: 24px;
            color: var(--principal);
        }

        .producto-info {
            flex: 1;
            min-width: 300px;
        }

        .producto-titulo {
            color: var(--principal);
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .producto-precio {
            font-size: 1.5em;
            color: var(--secundario);
            font-weight: bold;
            margin: 15px 0;
        }

        .producto-stock {
            color: var(--letrados);
            margin-bottom: 15px;
        }

        .producto-stock.disponible {
            color: var(--principal);
            font-weight: bold;
        }

        .producto-stock.agotado {
            color: red;
            font-weight: bold;
        }

        .producto-descripcion {
            margin: 20px 0;
            line-height: 1.6;
        }

        .producto-vendidos {
            color: var(--letrados);
            font-size: 0.9em;
        }

        .producto-categoria {
            display: inline-block;
            background-color: var(--terciario);
            padding: 5px 10px;
            border-radius: 15px;
            margin: 10px 5px 10px 0;
            font-size: 0.9em;
        }

        .categorias-container {
            margin: 10px 0;
        }

        .btn-a√±adir-carrito {
            background-color: var(--principal);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2em;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
            transition: background-color 0.3s;
        }

        .btn-a√±adir-carrito:hover {
            background-color: var(--secundario);
        }

        .btn-a√±adir-carrito:disabled {
            background-color: var(--letrados);
            cursor: not-allowed;
        }

        .video-reproductor {
            width: 100%;
            height: 400px;
            border: none;
            border-radius: 10px;
            display: none;
        }

        /* Estilos para el modal de listas */
        #listas-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            border-radius: 10px;
        }
        
        #listas-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        
        .lista-checkbox {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .lista-checkbox input {
            margin-right: 10px;
        }
        
        .lista-checkbox label {
            flex-grow: 1;
            cursor: pointer;
        }
        
        .btn-agregar-lista {
            background-color: var(--terciario);
            color: var(--principal);
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
            font-size: 1em;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-agregar-lista:hover {
            background-color: var(--secundario);
            color: white;
        }

        @media (max-width: 768px) {
            .producto-header {
                flex-direction: column;
            }
            
            .imagen-principal {
                height: 300px;
            }
            
            .video-reproductor {
                height: 250px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1><a href="main.html">Markline</a></h1>
        <nav>
            <button class="botones" onclick="location.href='Perfil.html'">Ver Perfil</button>
            <button class="botones" onclick="location.href='main.html'"> üè† Inicio</button>
            <button class="botones" onclick="openCart()"> üõí Carrito</button>
        </nav>
    </header>

    <main class="producto-detalle">
        <div class="producto-header">
            <div class="producto-imagenes">
                <img id="imagen-principal" class="imagen-principal" src="" alt="Imagen principal del producto">
                <video id="video-reproductor" class="video-reproductor" controls></video>
                
                <div class="miniaturas-container" id="miniaturas-container">
                    <!-- Las miniaturas se cargar√°n din√°micamente -->
                </div>
            </div>
            
            <div class="producto-info">
                <h1 id="producto-titulo" class="producto-titulo"></h1>
                <div id="categorias-container" class="categorias-container"></div>
                <div id="producto-precio" class="producto-precio"></div>
                <div id="producto-stock" class="producto-stock"></div>
                <div id="producto-vendidos" class="producto-vendidos"></div>
                
                <p id="producto-descripcion" class="producto-descripcion"></p>
                
                <button id="btn-a√±adir-carrito" class="btn-a√±adir-carrito">A√±adir al Carrito</button>
                <button id="btn-agregar-lista" class="btn-agregar-lista">‚ûï Agregar a Lista</button>
            </div>
        </div>
    </main>

    <!-- Modal para listas -->
    <div id="listas-overlay" onclick="closeListasModal()"></div>
    <div id="listas-modal">
        <h2>Agregar a Listas</h2>
        <div id="listas-container"></div>
        <button onclick="saveListChanges()" style="background-color:var(--principal); color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; width:100%; margin-top:15px;">Guardar Cambios</button>
        <button onclick="closeListasModal()" style="margin-top:10px; width:100%;">Cancelar</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Obtener el ID del producto de la URL
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');
            
            if (!productId) {
                alert('Producto no encontrado');
                window.location.href = 'main.html';
                return;
            }
            
            // Cargar los datos del producto
            fetch(`get_product_details.php?id=${productId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const product = data.product;
                        
                        // Mostrar la informaci√≥n del producto
                        document.getElementById('producto-titulo').textContent = product.nombre;
                        document.getElementById('producto-descripcion').textContent = product.descripcion;
                        document.getElementById('producto-precio').textContent = `$${product.precio}`;
                        document.getElementById('producto-vendidos').textContent = `${product.vendidos} vendidos`;
                        
                        // Mostrar categor√≠as
                        const categoriasContainer = document.getElementById('categorias-container');
                        categoriasContainer.innerHTML = '';
                        
                        if (product.categorias && product.categorias.length > 0) {
                            product.categorias.forEach(categoria => {
                                const span = document.createElement('span');
                                span.className = 'producto-categoria';
                                span.textContent = categoria;
                                categoriasContainer.appendChild(span);
                            });
                        } else if (product.categoria) {
                            // Para compatibilidad con versiones anteriores
                            const span = document.createElement('span');
                            span.className = 'producto-categoria';
                            span.textContent = product.categoria;
                            categoriasContainer.appendChild(span);
                        }
                        
                        // Mostrar el stock
                        const stockElement = document.getElementById('producto-stock');
                        if (product.stock > 0) {
                            stockElement.textContent = `Disponibles: ${product.stock}`;
                            stockElement.classList.add('disponible');
                            document.getElementById('btn-a√±adir-carrito').disabled = false;
                        } else {
                            stockElement.textContent = 'AGOTADO';
                            stockElement.classList.add('agotado');
                            document.getElementById('btn-a√±adir-carrito').disabled = true;
                        }
                        
                        // Mostrar imagen principal por defecto
                        if (product.imagenPrincipal) {
                            document.getElementById('imagen-principal').src = product.imagenPrincipal;
                        }

                        // Cargar miniaturas
                        const miniaturasContainer = document.getElementById('miniaturas-container');
                        miniaturasContainer.innerHTML = '';

                        // Crear miniatura para la imagen principal
                        if (product.imagenPrincipal) {
                            const miniaturaPrincipal = document.createElement('img');
                            miniaturaPrincipal.className = 'miniatura seleccionada';
                            miniaturaPrincipal.src = product.imagenPrincipal;
                            miniaturaPrincipal.alt = 'Imagen principal';
                            miniaturaPrincipal.onclick = () => {
                                // Mostrar imagen principal
                                document.getElementById('imagen-principal').style.display = 'block';
                                document.getElementById('video-reproductor').style.display = 'none';
                                
                                // Actualizar selecci√≥n
                                document.querySelectorAll('.miniatura').forEach(m => m.classList.remove('seleccionada'));
                                miniaturaPrincipal.classList.add('seleccionada');
                            };
                            miniaturasContainer.appendChild(miniaturaPrincipal);
                        }

                        // Crear miniaturas para im√°genes extras
                        [product.imagenExtra1, product.imagenExtra2].forEach((imagen, index) => {
                            if (imagen) {
                                const miniatura = document.createElement('img');
                                miniatura.className = 'miniatura';
                                miniatura.src = imagen;
                                miniatura.alt = `Imagen extra ${index + 1}`;
                                miniatura.onclick = () => {
                                    // Mostrar imagen seleccionada
                                    document.getElementById('imagen-principal').src = imagen;
                                    document.getElementById('imagen-principal').style.display = 'block';
                                    document.getElementById('video-reproductor').style.display = 'none';
                                    
                                    // Actualizar selecci√≥n
                                    document.querySelectorAll('.miniatura').forEach(m => m.classList.remove('seleccionada'));
                                    miniatura.classList.add('seleccionada');
                                };
                                miniaturasContainer.appendChild(miniatura);
                            }
                        });

                        // Crear miniatura para el video si existe
                        if (product.video) {
                            const miniaturaVideo = document.createElement('div');
                            miniaturaVideo.className = 'miniatura miniatura-video';
                            miniaturaVideo.onclick = () => {
                                // Mostrar video
                                const videoPlayer = document.getElementById('video-reproductor');
                                videoPlayer.src = product.video;
                                videoPlayer.style.display = 'block';
                                document.getElementById('imagen-principal').style.display = 'none';
                                
                                // Actualizar selecci√≥n
                                document.querySelectorAll('.miniatura').forEach(m => m.classList.remove('seleccionada'));
                                miniaturaVideo.classList.add('seleccionada');
                                
                                // Reproducir video autom√°ticamente
                                videoPlayer.play();
                            };
                            miniaturasContainer.appendChild(miniaturaVideo);
                        }
                        
                        // Configurar bot√≥n de a√±adir al carrito
                        document.getElementById('btn-a√±adir-carrito').addEventListener('click', function() {
                            if (product.stock > 0) {
                                addToCart(product);
                            }
                        });
                    } else {
                        alert('Error al cargar el producto: ' + data.error);
                        window.location.href = 'main.html';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al cargar el producto');
                    window.location.href = 'main.html';
                });
        });
        
        function addToCart(product) {
            const username = sessionStorage.getItem('username');
            if (!username) {
                alert('Debes iniciar sesi√≥n para a√±adir al carrito');
                window.location.href = 'index.html';
                return;
            }

            fetch('carrito_api.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + username
                },
                body: JSON.stringify({
                    productoId: product.id,
                    cantidad: 1
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Producto a√±adido al carrito');
                    // Actualizar el contador del carrito en la p√°gina principal si est√° en un iframe
                    if (window.parent && window.parent.updateCartCount) {
                        window.parent.updateCartCount();
                    }
                } else {
                    alert('Error al a√±adir al carrito: ' + (data.error || ''));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al a√±adir al carrito');
            });
        }

        function openCart() {
            // Si estamos en un iframe, delegamos al padre
            if (window.parent && window.parent.openCart) {
                window.parent.openCart();
            } else {
                // Redirigir a la p√°gina principal con el carrito abierto
                window.location.href = 'main.html#openCart';
            }
        }

        function openListasModal() {
            document.getElementById('listas-overlay').style.display = 'block';
            document.getElementById('listas-modal').style.display = 'block';
            loadUserLists();
        }

        function closeListasModal() {
            document.getElementById('listas-overlay').style.display = 'none';
            document.getElementById('listas-modal').style.display = 'none';
        }

        function loadUserLists() {
            const username = sessionStorage.getItem('username');
            const productId = new URLSearchParams(window.location.search).get('id');
            
            if (!username || !productId) {
                alert('Error al cargar listas');
                return;
            }
            
            fetch(`get_user_lists.php?username=${encodeURIComponent(username)}&productId=${productId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const container = document.getElementById('listas-container');
                        container.innerHTML = '';
                        
                        if (data.lists.length === 0) {
                            container.innerHTML = '<p>No tienes listas creadas. Crea una lista desde tu perfil.</p>';
                            return;
                        }
                        
                        data.lists.forEach(lista => {
                            const listItem = document.createElement('div');
                            listItem.className = 'lista-checkbox';
                            listItem.innerHTML = `
                                <input type="checkbox" id="lista-${lista.ID}" ${lista.enLista ? 'checked' : ''}>
                                <label for="lista-${lista.ID}">${lista.Nombre} (${lista.Status})</label>
                            `;
                            container.appendChild(listItem);
                        });
                    } else {
                        alert('Error al cargar listas: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al cargar listas');
                });
        }

        function saveListChanges() {
            const username = sessionStorage.getItem('username');
            const productId = new URLSearchParams(window.location.search).get('id');
            const checkboxes = document.querySelectorAll('#listas-container input[type="checkbox"]');
            
            if (!username || !productId) {
                alert('Error al guardar cambios');
                return;
            }
            
            const changes = Array.from(checkboxes).map(checkbox => {
                const listId = checkbox.id.split('-')[1];
                return {
                    listId: listId,
                    checked: checkbox.checked
                };
            });
            
            fetch('update_product_lists.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: username,
                    productId: productId,
                    changes: changes
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeListasModal();
                } else {
                    alert('Error al guardar cambios: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al guardar cambios');
            });
        }

        document.getElementById('btn-agregar-lista').addEventListener('click', openListasModal);
    </script>
</body>
</html>